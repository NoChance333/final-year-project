<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/novisfavicon-32x32.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/novisfavicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/novisfavicon-16x16.png') }}">
    
    <style>
        html, body {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        .dropdown {
            position: absolute;
            right: 0;
            min-width: 200px;
            max-width: 90vw;
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .dropdown.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        #update-name-card, #change-password-card, #upload-form-card {
            z-index: 1000;
        }

        #update-name-card form, #change-password-card form, #upload-form-card form {
            max-width: 400px;
            margin: 0 auto;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
    
    <!-- Navigation -->
    <nav class="px-6 py-4 flex items-center justify-between flex-wrap">
        <div class="flex items-center">
            <!-- Novis Logo -->
            <div class="relative flex items-center justify-center w-48 h-24">
                <img src="{{ url_for('static', filename='images/novis.png') }}" alt="Logo">
            </div>
        </div>

        <!-- Navbar Links -->
        <div class="flex items-center space-x-6 text-lg font-medium flex-wrap">
            <a href="#" class="text-gray-800 hover:translate-x-1 transition-transform duration-200">Home</a>
            <div class="relative" id="dashboard-container">
                <button onclick="toggleDashboardDropdown()" class="text-gray-800 hover:translate-x-1 transition-transform duration-200">
                    Dashboard
                </button>
                
                <!-- Dashboard Dropdown -->
                <!-- Dashboard Dropdown -->
<div id="dashboard-dropdown" class="dropdown absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-lg py-2 z-10 hidden">
                    <!-- Number of Files Uploaded -->
                    <div class="px-4 py-2 text-sm text-gray-700">
                        <span class="font-medium">Number of Files Uploaded:</span>
                        <span id="files-count">Loading...</span>
                    </div>
            
                    <!-- Number of Tokens Created -->
                    <div class="px-4 py-2 text-sm text-gray-700">
                        <span class="font-medium">Number of Tokens Created:</span>
                        <span id="tokens-count">Loading...</span>
                    </div>
            
                    <!-- Blocks Where Contracts Are Deployed -->
                    <div class="px-4 py-2 text-sm text-gray-700">
                        <span class="font-medium">Deployed Blocks:</span>
                        <span id="deployed-blocks">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Upload Link with Dropdown -->
<div class="relative" id="upload-container">
    <button onclick="toggleUploadDropdown(event)" class="text-gray-800 hover:translate-x-1 transition-transform duration-200">
        Upload
    </button>
    
    <!-- Upload Dropdown -->
    <div id="upload-dropdown" class="dropdown absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-10 hidden">
        <button onclick="showUploadForm('pdf')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                <path d="M14 2v6h6"/>
            </svg>
            Upload PDF
        </button>
        <button onclick="showUploadForm('png')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <path d="M21 15l-5-5L5 21"/>
            </svg>
            Upload PNG
        </button>
        <button onclick="openMintTokenModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
            Mint Token
        </button>        
    </div>
</div>
            <!-- Transaction Link with Dropdown -->
<div class="relative" id="transaction-container">
    <button onclick="toggleTransactionDropdown()" class="text-gray-800 hover:translate-x-1 transition-transform duration-200 flex items-center">
        Transaction
        <span id="chain-status-indicator" class="ml-2 w-3 h-3 rounded-full bg-red-500"></span>
    </button>

    <!-- Transaction Dropdown -->
    <div id="transaction-dropdown" class="dropdown absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-lg py-2 z-10">
        <div class="px-4 py-2 text-sm font-semibold text-gray-700 border-b flex items-center">
            Chain Status: 
            <span id="chain-status-text" class="ml-2 text-red-500">Not Running</span>
        </div>
        <div id="transaction-list" class="max-h-60 overflow-y-auto">
            <p class="px-4 py-2 text-sm text-gray-500">Loading transactions...</p>
        </div>
    </div>
</div>

            <!-- Help & Support Link with Dropdown -->
<!-- Help & Support Link with Dropdown -->
<div class="relative" id="nav-help-container">
    <button onclick="toggleNavHelpDropdown()" class="text-gray-800 hover:translate-x-1 transition-transform duration-200">
        Help & Support
    </button>

    <!-- Help & Support Dropdown -->
    <div id="nav-help-dropdown" class="dropdown absolute left-1/2 transform -translate-x-1/2 mt-2 w-64 bg-white rounded-lg shadow-lg py-2 z-10">
        <button onclick="showHelpModal('What is Novis?', 'Novis is a blockchain-based platform for securely storing and tokenizing digital assets.')" 
                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
            What is Novis?
        </button>
        <button onclick="showHelpModal('How does IPFS storage work?', 'IPFS (InterPlanetary File System) is a decentralized storage network that allows you to store files securely and retrieve them via a unique CID.')"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
            How does IPFS storage work?
        </button>
        <button onclick="showHelpModal('How do I mint a token for my asset?', 'Minting a token converts your uploaded asset into a blockchain-based token that represents ownership.')"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
            How do I mint a token for my asset?
        </button>
        <button onclick="showHelpModal('How can I check my transactions?', 'You can check your transactions in the Transactions tab or on the blockchain explorer.')"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
            How can I check my transactions?
        </button>
    </div>
</div>

<!-- Help & Support Modal -->
<div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96 relative">
        <!-- Close Button -->
        <button onclick="closeHelpModal()" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <!-- Title -->
        <h2 id="help-modal-title" class="text-2xl font-bold mb-4 text-center"></h2>

        <!-- Answer -->
        <p id="help-modal-text" class="text-gray-700 text-center"></p>
    </div>
</div>

            
            <!-- Profile Link with Dropdown -->
            <div class="relative" id="nav-profile-container">
                <button onclick="toggleNavProfileDropdown()" class="text-gray-800 hover:translate-x-1 transition-transform duration-200">
                    Profile
                </button>
                
                <!-- Profile Navigation Dropdown -->
                <div id="nav-profile-dropdown" class="dropdown absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-10">
                    <button onclick="handleNavUpdateName()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z"/>
                            <path d="M12 14C8.13401 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z"/>
                        </svg>
                        Update Name
                    </button>
                    <button onclick="handleNavChangePassword()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        Change Password
                    </button>
                </div>
            </div>

            <!-- Update Name Modal -->
            <div id="update-name-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" onclick="closeUpdateNameModal(event)">
                <div class="bg-white rounded-lg shadow-lg p-6 w-96 relative" onclick="event.stopPropagation()">
                    <!-- Notification Message -->
                    <div id="update-name-success" class="hidden bg-green-500 text-white text-center p-2 rounded-md">
                        Name updated successfully!
                    </div>

                    <!-- Close Button -->
                    <button onclick="closeUpdateNameModal()" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    
                    <h2 class="text-2xl font-bold mb-4 text-center">Update Name</h2>
                    <form id="update-name-form">
                        <div class="mb-4">
                            <label for="new-name" class="block text-sm font-medium text-gray-700">New Name</label>
                            <input type="text" id="new-name" name="new-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="current-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                            <input type="password" id="current-password" name="current-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Update Name
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Change Password Modal -->
            <div id="change-password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 w-96 relative">
                    <!-- Close Button -->
                    <button onclick="closeChangePasswordModal()" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
            
                    <h2 class="text-2xl font-bold mb-4 text-center">Change Password</h2>
                    <form id="change-password-form">
                        <div class="mb-4">
                            <label for="current-password-change" class="block text-sm font-medium text-gray-700">Current Password</label>
                            <input type="password" id="current-password-change" name="current-password-change" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                            <input type="password" id="new-password" name="new-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                            <input type="password" id="confirm-password" name="confirm-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Change Password
                        </button>
                    </form>
                </div>
            </div>

            <!-- User Profile / Login Button -->
            <div class="relative" id="profile-container">
                <!-- Login Button (shown when logged out) -->
                <div id="login-button" class="flex items-center space-x-1 cursor-pointer hover:translate-x-1 transition-transform duration-200 text-lg">
                    <a href="{{ url_for('login_page') }}">Login</a>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-800" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m19 9-7 7-7-7"></path>
                    </svg>
                </div>

                <!-- User Profile Button (shown when logged in) -->
                <!-- Profile Button -->
<div id="profile-button" class="flex items-center space-x-2 cursor-pointer relative">
    <img id="user-profile-img" class="w-8 h-8 rounded-full border-2 border-gray-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-800 transition-transform duration-200" id="profile-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m19 9-7 7-7-7"></path>
    </svg>
</div>

<!-- Dropdown Menu -->
<div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-10 hidden">
    <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-50">
        Logout
    </button>
</div>

            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <main class="max-w-screen-xl w-full mx-auto px-6 py-12 flex flex-col md:flex-row items-center gap-6 overflow-hidden">
        <!-- Left side - Image -->
        <div class="w-full md:w-1/2">
            <img 
                src="https://images.unsplash.com/photo-1593062096033-9a26b09da705?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" 
                alt="Person working at desk" 
                class="rounded-2xl shadow-xl w-full"
            />
        </div>
    
        <!-- Right side - Content -->
        <div class="w-full md:w-1/2 text-center md:text-left">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6 leading-tight">
                Where Digital<br>
                Meets Ownership
            </h1>
            <p class="text-lg text-gray-700 mb-8">
                Novis brings the power of blockchain to your documents, ensuring transparency, security, and true ownership.
            </p>
            <a href="{{ url_for('signup_page') }}" id="get-started-button" class="group inline-flex items-center">
                <span class="flex items-center">
                    <span class="mr-4 text-lg font-medium">Get Started with Your First Upload</span>
                    <div class="w-10 h-10 rounded-full border-2 border-black flex items-center justify-center transition-transform group-hover:translate-x-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14"></path>
                            <path d="m12 5 7 7-7 7"></path>
                        </svg>
                    </div>
                </span>
            </a>
        </div>
    </main>

    <!-- Update Name Card -->
    <div id="update-name-card" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-96">
            <h2 class="text-2xl font-bold mb-6 text-center">Update Name</h2>
            <form id="update-name-form">
                <div class="mb-4">
                    <label for="new-name" class="block text-sm font-medium text-gray-700">New Name</label>
                    <input type="text" id="new-name" name="new-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="current-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                    <input type="password" id="current-password" name="current-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Update Name
                </button>
            </form>
        </div>
    </div>

    <!-- Upload Form Card -->
<div id="upload-form-card" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg p-8 w-96 relative">
        <!-- Close Button (Cross Mark) -->
        <button onclick="hideUploadForm()" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <h2 id="upload-form-title" class="text-2xl font-bold mb-6 text-center">Upload File</h2>
        <form id="upload-form" enctype="multipart/form-data" method="POST">
            <div class="mb-4">
                <label for="file" class="block text-sm font-medium text-gray-700">Choose File</label>
                <input type="file" id="file" name="file" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" accept=".pdf,.png" required>
            </div>
            <div class="mb-6">
                <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="description" name="description" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" rows="3"></textarea>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Upload
            </button>
        </form>

        <!-- ✅ Success Message (Added this part) -->
        <div id="upload-success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-2 rounded-lg mt-4 text-center">
            ✅ File uploaded successfully!
        </div>

    </div>
</div>

    <!-- Change Password Card -->
    <div id="change-password-card" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg p-8 w-96">
            <h2 class="text-2xl font-bold mb-6 text-center">Change Password</h2>
            <form id="change-password-form" method="POST">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                    <input type="password" id="new-password" name="new-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" name="confirm-new-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Change Password
                </button>
            </form>
        </div>
    </div>
    <div id="toast-container" class="toast-container"></div>

    <!-- Mint Token Modal -->
<div id="mint-token-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96 relative">
        <button onclick="hideMintTokenModal()" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900">
            ✖
        </button>

        <h2 class="text-xl font-bold mb-4 text-center">Mint NFT</h2>

        <div id="file-list" class="max-h-60 overflow-y-auto border p-3 rounded-md mb-4">
            <!-- File checkboxes will be dynamically added here -->
        </div>

        <button onclick="mintToken()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
            Mint Selected Tokens
        </button>

        <div id="mint-success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-2 rounded-lg mt-4 text-center">
            ✅ NFT minted successfully!
        </div>
    </div>
</div>


<style>
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}
.toast {
    padding: 10px 15px;
    margin-bottom: 10px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    display: inline-block;
}
.toast.success { background: #4CAF50; }
.toast.error { background: #F44336; }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    checkAuthStatus();

    const uploadForm = document.getElementById("upload-form");

if (uploadForm) {
    uploadForm.addEventListener("submit", async function (event) {
        event.preventDefault();  // Prevent page refresh

        const fileInput = document.getElementById("file");
        const descriptionInput = document.getElementById("description");
        const successMessage = document.getElementById("upload-success-message");

        if (!fileInput.files.length) {
            showToastMessage("Please select a file.", "error");
            return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]); 
        formData.append("description", descriptionInput.value);

        try {
            const response = await fetch("/upload", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                },
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Upload failed");
            }

            // ✅ Show success message instead of alert
            successMessage.innerHTML = `✅ File uploaded successfully! CID: <span class="font-bold">${data.cid}</span>`;
            successMessage.classList.remove("hidden");

            // ✅ Keep the message visible for a few seconds, then hide the form
            setTimeout(() => {
                successMessage.classList.add("hidden");
                hideUploadForm();
            }, 3000);

        } catch (error) {
            console.error("Upload error:", error);
            showToastMessage("Error: " + error.message, "error");
        }
    });
}

    // ✅ Attach click event for profile dropdown
    const profileButton = document.getElementById('profile-button');
    if (profileButton) {
        profileButton.addEventListener('click', toggleProfileDropdown);
    }

    // ✅ Close dropdown when clicking outside
    document.addEventListener('click', function (event) {
        const dropdown = document.getElementById('profile-dropdown');
        const profileButton = document.getElementById('profile-button');

        if (dropdown && !profileButton.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.classList.add('hidden');  // Hide dropdown
        }
    });
    function toggleProfileDropdown(event) {
    event.stopPropagation();  // Prevent closing immediately

    const dropdown = document.getElementById('profile-dropdown');
    if (dropdown) {
        dropdown.classList.toggle('hidden');  // Toggle visibility using Tailwind
    } else {
        console.error("Dropdown element not found");
    }
}
    
        // ✅ Handle change password form submission (FIXED)
        const changePasswordForm = document.getElementById('change-password-form');
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', function (event) {
                event.preventDefault();
    
                const email = localStorage.getItem('user_email')?.trim() || '';  
                const currentPassword = document.getElementById('current-password-change')?.value.trim() || '';
                const newPassword = document.getElementById('new-password')?.value.trim() || '';
                const confirmPassword = document.getElementById('confirm-password')?.value.trim() || '';
    
                console.log("Email:", email);  // ✅ Debug log
                console.log("Current Password:", !!currentPassword);
                console.log("New Password:", !!newPassword);
                console.log("Confirm Password:", !!confirmPassword);
    
                if (!email || !currentPassword || !newPassword || !confirmPassword) {
                    showToastMessage("All fields are required", "error");
                    return;
                }
    
                if (newPassword !== confirmPassword) {
                    showToastMessage("Passwords do not match", "error");
                    return;
                }
    
                fetch('/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,  
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToastMessage(data.error, "error");
                    } else {
                        showToastMessage("Password changed successfully", "success");
                        setTimeout(() => {
                            closeChangePasswordModal();
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToastMessage("An error occurred. Please try again.", "error");
                });
            });
        }
    });

    const updateNameForm = document.getElementById("update-name-form");
    if (updateNameForm) {
        updateNameForm.addEventListener("submit", function (event) {
            event.preventDefault();  // Prevents default form submission

            const newName = document.getElementById("new-name").value.trim();
            const currentPassword = document.getElementById("current-password").value.trim();
            const email = localStorage.getItem("user_email") || "";

            if (!newName || !currentPassword || !email) {
                showToastMessage("All fields are required", "error");
                return;
            }

            fetch("/update_name", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    email: email,
                    new_name: newName,
                    current_password: currentPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToastMessage(data.error, "error");
                } else {
                    showToastMessage("Name updated successfully!", "success");

                    // ✅ Update UI with new name
                    const userNameSpan = document.getElementById("user-name");
if (userNameSpan) {
    userNameSpan.textContent = userData.full_name || "User";
} else {
    console.warn("Warning: user-name element not found in the DOM.");
}

                    // ✅ Close modal after success
                    setTimeout(() => closeUpdateNameModal(), 2000);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                showToastMessage("An error occurred. Please try again.", "error");
            });
        });
    }

// ✅ Close update name modal
function closeUpdateNameModal() {
    document.getElementById("update-name-modal")?.classList.add("hidden");
}
    
    // ✅ Fix: Store email in localStorage after login
    function checkAuthStatus() {
    const token = localStorage.getItem('access_token');
    if (token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const currentTime = Math.floor(Date.now() / 1000);

            if (payload.exp && payload.exp < currentTime) {
                localStorage.clear();
                updateUIForLoggedOutUser();
                return;
            }

            // ✅ Fix: Extract email from `sub`
            if (payload.sub && payload.sub.email) {
                localStorage.setItem('user_email', payload.sub.email);
            } else {
                console.error("Email not found in token payload:", payload);
            }

            updateUIForLoggedInUser();
        } catch (error) {
            console.error("Token validation error:", error);
            localStorage.clear();
            updateUIForLoggedOutUser();
        }
    } else {
        updateUIForLoggedOutUser();
    }
}
    
    // ✅ Close Change Password Modal (FIXED)
    function closeChangePasswordModal(event) {
        event?.stopPropagation();
        document.getElementById("change-password-modal")?.classList.add("hidden");
    }
    
    // UI update functions
    function updateUIForLoggedInUser() {
        document.getElementById('login-button')?.classList.add('hidden');
        document.getElementById('profile-button')?.classList.remove('hidden');
        document.getElementById('get-started-button')?.classList.add('hidden');
    
        const userData = getUserDataFromToken();
        if (userData?.email) {
            document.getElementById('user-name').textContent = userData.full_name || "User";
            document.getElementById('user-profile-img').src = userData.profile_image || getGravatarUrl(userData.email);
        }
    }
    
    function updateUIForLoggedOutUser() {
        document.getElementById('login-button')?.classList.remove('hidden');
        document.getElementById('profile-button')?.classList.add('hidden');
        document.getElementById('get-started-button')?.classList.remove('hidden');
        document.getElementById('profile-dropdown')?.classList.remove('show');
    }
    
    // Extract user data from token
    function getUserDataFromToken() {
        const token = localStorage.getItem("access_token");
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return { full_name: payload.full_name || "User", email: payload.email };
            } catch (error) {
                console.error("Error decoding token:", error);
            }
        }
        return {};
    }
    
    // ✅ Fix: Define missing function
    function toggleNavProfileDropdown() {
        document.getElementById('nav-profile-dropdown')?.classList.toggle('show');
    }
    
    // Toggle dropdowns
    function toggleProfileDropdown(event) {
        event?.stopPropagation();
        document.getElementById('profile-dropdown')?.classList.toggle('show');
    }
    
    // Handle modals
    function handleNavUpdateName() {
        document.getElementById("update-name-modal")?.classList.remove("hidden");
    }
    
    function handleNavChangePassword() {
        document.getElementById("change-password-modal")?.classList.remove("hidden");
    }
    
    // Handle logout
    function handleLogout() {
        localStorage.clear();
        updateUIForLoggedOutUser();
    }
    
    // Show toast messages
    function showToastMessage(message, type) {
        const toastContainer = document.getElementById("toast-container");
        if (!toastContainer) return;
    
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
    
        setTimeout(() => toast.remove(), 3000);
    }
    
    // Get Gravatar image
    function getGravatarUrl(email) {
        if (typeof CryptoJS !== 'undefined') {
            return `https://www.gravatar.com/avatar/${CryptoJS.MD5(email.trim().toLowerCase())}?d=identicon`;
        }
        return 'https://www.gravatar.com/avatar/?d=identicon';
    }

    // ✅ Fix: Close Update Name Modal
function closeUpdateNameModal(event) {
    event?.stopPropagation();  // Prevent event bubbling
    document.getElementById("update-name-modal")?.classList.add("hidden");
}

function toggleProfileDropdown(event) {
    event?.stopPropagation();  // Prevents event bubbling
    const dropdown = document.getElementById('profile-dropdown');
    
    if (dropdown) {
        dropdown.classList.toggle('hidden');  // Tailwind way to toggle visibility
    } else {
        console.error("Dropdown element not found");
    }
}

function toggleUploadDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('upload-dropdown');

    if (dropdown) {
        if (dropdown.classList.contains('hidden')) {
            dropdown.classList.remove('hidden');  // Remove Tailwind's hidden class
            dropdown.classList.add('show');  // Add custom show class
        } else {
            dropdown.classList.add('hidden');  // Hide dropdown again
            dropdown.classList.remove('show');  // Remove custom show class
        }
        console.log("Dropdown toggled. Current classList:", dropdown.classList);
    } else {
        console.error("Upload dropdown element not found");
    }
}

function showUploadForm(fileType) {
    console.log("Uploading file type:", fileType); // Debugging log

    const uploadFormCard = document.getElementById("upload-form-card");
    if (!uploadFormCard) {
        console.error("Upload form card element not found.");
        return;
    }

    // Ensure correct file input ID
    const fileInput = document.getElementById("file");
    if (!fileInput) {
        console.error("File input element not found.");
        return;
    }

    // Set file type restriction
    if (fileType === "pdf") {
        fileInput.setAttribute("accept", "application/pdf");
    } else if (fileType === "png") {
        fileInput.setAttribute("accept", "image/png");
    } else {
        fileInput.removeAttribute("accept"); // Allow all types if not specified
    }

    // Show the upload modal
    uploadFormCard.classList.remove("hidden");
}

function submitUploadForm() {
    const fileInput = document.getElementById("file-input");
    if (!fileInput || !fileInput.files.length) {
        alert("Please select a file.");
        return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    fetch("/upload", {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${localStorage.getItem("access_token")}` // Ensure the user is authenticated
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            alert("File uploaded successfully: " + data.cid);
            closeUploadForm();
        }
    })
    .catch(error => {
        console.error("Upload error:", error);
        alert("An error occurred while uploading.");
    });
}

function closeUploadForm() {
    document.getElementById("upload-form")?.classList.add("hidden");
}

function hideUploadForm() {
    const uploadForm = document.getElementById("upload-form-card");
    if (uploadForm) {
        uploadForm.classList.add("hidden");
    } else {
        console.error("Upload form card element not found.");
    }
}


async function openMintTokenModal() {
    const fileList = document.getElementById("file-list");
    fileList.innerHTML = "<p>Loading...</p>"; // Show loading message

    try {
        const response = await fetch("/get_uploaded_files", {
            method: "GET",
            headers: { "Authorization": `Bearer ${localStorage.getItem("access_token")}` },
        });

        const data = await response.json();
        fileList.innerHTML = ""; // Clear loading

        if (!response.ok || data.files.length === 0) {
            fileList.innerHTML = "<p>No files found</p>";
            return;
        }

        // ✅ Create checkboxes for each file
        data.files.forEach(file => {
            const div = document.createElement("div");
            div.className = "flex items-center mb-2 border p-2 rounded";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = file.cid;
            checkbox.className = "mr-2";
            checkbox.name = "fileCheckbox";

            const label = document.createElement("label");
            label.innerHTML = `<b>${file.file_name}</b> <br> CID: ${file.cid} <br> Date: ${file.upload_date}`;

            div.appendChild(checkbox);
            div.appendChild(label);
            fileList.appendChild(div);
        });

        // ✅ Show the modal
        document.getElementById("mint-token-modal").classList.remove("hidden");

    } catch (error) {
        console.error("Error fetching uploaded files:", error);
    }
}



async function mintToken() {
    const checkboxes = document.querySelectorAll("input[name='fileCheckbox']:checked");
    const mintSuccessMessage = document.getElementById("mint-success-message");

    if (checkboxes.length === 0) {
        alert("Please select at least one file to mint.");
        return;
    }

    for (const checkbox of checkboxes) {
        const cid = checkbox.value;

        try {
            const response = await fetch("/mint", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("access_token")}`,
                },
                body: JSON.stringify({ cid }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Minting failed");
            }

            // ✅ Show success message for each minted file
            mintSuccessMessage.innerHTML = `✅ NFT minted! Contract: <span class="font-bold">${data.contract_address}</span>`;
            mintSuccessMessage.classList.remove("hidden");

            await new Promise(resolve => setTimeout(resolve, 1500)); // Delay between mints

        } catch (error) {
            console.error("Minting error:", error);
            alert("Error: " + error.message);
        }
    }

    // Hide after completion
    setTimeout(() => {
        mintSuccessMessage.classList.add("hidden");
        hideMintTokenModal();
    }, 3000);
}

function hideMintTokenModal() {
    document.getElementById("mint-token-modal").classList.add("hidden");
}


async function fetchUploadedFiles() {
    try {
        const response = await fetch("/get_uploaded_files", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${localStorage.getItem("access_token")}` // Include the token
            }
        });

        if (!response.ok) {
            throw new Error("Failed to fetch uploaded files");
        }

        const data = await response.json();
        console.log("Fetched Files:", data);
        // Now populate the modal with these files
        populateMintModal(data);
    } catch (error) {
        console.error("Error fetching uploaded files:", error);
        alert("Failed to fetch uploaded files");
    }
}



function toggleDashboardDropdown() {
    const dropdown = document.getElementById("dashboard-dropdown");
    dropdown.classList.toggle("hidden");
    if (!dropdown.classList.contains("hidden")) {
        fetchDashboardData();
    }
}

// ✅ Define fetchDashboardData globally
async function fetchDashboardData() {
    try {
        const token = localStorage.getItem("access_token");
        if (!token) {
            console.error("JWT token is missing");
            return;
        }

        const headers = { "Authorization": `Bearer ${token}` };

        // Fetch number of uploaded files
        const filesResponse = await fetch("/dashboard/files-count", { method: "GET", headers });
        if (!filesResponse.ok) throw new Error("Failed to fetch files count");
        const filesData = await filesResponse.json();
        document.getElementById("files-count").textContent = filesData.files_count || 0;

        // Fetch number of tokens created
        const tokensResponse = await fetch("/dashboard/tokens-count", { method: "GET", headers });
        if (!tokensResponse.ok) throw new Error("Failed to fetch tokens count");
        const tokensData = await tokensResponse.json();
        document.getElementById("tokens-count").textContent = tokensData.tokens_count || 0;

        // Fetch deployed blocks
        const blocksResponse = await fetch("/dashboard/deployed-blocks", { method: "GET", headers });
        if (!blocksResponse.ok) throw new Error("Failed to fetch deployed blocks");
        const blocksData = await blocksResponse.json();
        document.getElementById("deployed-blocks").textContent = blocksData.deployed_blocks.length > 0
            ? blocksData.deployed_blocks.join(", ")
            : "None";

    } catch (error) {
        console.error("Error fetching dashboard data:", error);
    }
}




    </script>
    
    
</body>
</html>
